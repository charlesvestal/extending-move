{% extends "base.html" %}
{% block content %}
<h2>Drum Rack Inspector</h2>
<p><em>Note: this inspects the samples from a drum rack, and shows an individual slice based on start and length information. Reversing or time stretching a sample will create a new copy of the raw sound file itself, and keep your sliced region.</em></p>
{% if message %}
  <p style="color: {{ 'green' if success else 'red' }};">{{ message }}</p>
{% endif %}
<form method="post" action="/drum-rack-inspector">
  <input type="hidden" name="action" value="select_preset">
  <label for="preset_select">Select a Drum Rack:</label>
  <select name="preset_select" id="preset_select">
    {{ options_html | safe }}
  </select>
  <button type="submit">Load</button>
</form>
<div class="samples-container">
  {{ samples_html | safe }}
</div>
<!-- Time Stretch Modal -->
<style>
.modal .loading-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.8);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.25rem;
  z-index: 10;
}
.modal .loading-overlay.hidden { display: none; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal.hidden { display: none; }
.modal-content { background: #fff; padding: 20px; border-radius: 4px; position: relative; z-index: 1001; }
.modal-close { position: absolute; top: 10px; right: 10px; cursor: pointer; }
#timeStretchModal input[type="number"] { width: auto; max-width: none; }
</style>
<div id="timeStretchModal" class="modal hidden">
  <div class="modal-content">
    <span class="modal-close" onclick="document.getElementById('timeStretchModal').classList.add('hidden')">&times;</span>
    <div id="ts_loading" class="loading-overlay hidden">Time stretchingâ€¦</div>
    <form method="post" action="/drum-rack-inspector" id="timeStretchForm" onsubmit="event.preventDefault(); submitTimeStretchForm();">
      <input type="hidden" name="action" value="time_stretch_sample">
      <input type="hidden" name="sample_path" id="ts_sample_path">
      <input type="hidden" name="preset_path" id="ts_preset_path">
      <input type="hidden" name="pad_number" id="ts_pad_number">
      <label for="ts_bpm">BPM:</label>
      <input type="number" name="bpm" id="ts_bpm" step="any" required value="120">
      <label for="ts_measures">Measures:</label>
      <input type="number" name="measures" id="ts_measures" step="any" required value="1.0">
      <label for="ts_preserve_pitch"><input type="checkbox" name="preserve_pitch" id="ts_preserve_pitch" checked> Preserve pitch</label>
      <div id="ts_algorithm_container">
        <label for="ts_algorithm">Algorithm:</label>
        <select name="algorithm" id="ts_algorithm">
          <option value="wsola" selected>WSOLA (best for drums)</option>
          <option value="phase">Phase-Vocoder (best for melodic)</option>
        </select>
      </div>
      <button type="submit" class="apply-time-stretch-button">Apply</button>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://unpkg.com/wavesurfer.js@6/dist/wavesurfer.js"></script>
<script src="/static/drum_rack_page.js"></script>
<script>
function submitTimeStretchForm() {
  const form = document.getElementById('timeStretchForm');
  const loading = document.getElementById('ts_loading');
  const btn = form.querySelector('button[type="submit"]');
  btn.disabled = true;
  loading.classList.remove('hidden');
  const data = new FormData(form);
  fetch(form.action, {method: 'POST', body: data})
    .then(r => r.text())
    .then(html => {
      loading.classList.add('hidden');
      btn.disabled = false;
      document.querySelector('.tabcontent').innerHTML = html;
    })
    .catch(e => {
      console.error(e);
      loading.classList.add('hidden');
      btn.disabled = false;
    });
}
</script>
{% endblock %}
