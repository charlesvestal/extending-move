<!DOCTYPE html>
<html>
    <head>
        <title>Move - Extended</title>
        <link rel="stylesheet" href="/style.css">
        
        <!-- Include WaveSurfer core and the Regions plugin -->
        <script src="https://unpkg.com/wavesurfer.js@6/dist/wavesurfer.js"></script>
        <script src="https://unpkg.com/wavesurfer.js@6/dist/plugin/wavesurfer.regions.js"></script>

        <script>
            let wavesurfer;      // For the main WaveSurfer instance
            let audioReady = false; // Flag to track whether audio is loaded

            function openTab(evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";

                // Dynamically load the content
                fetchContent(tabName).then(() => {
                    attachFormHandler(tabName);
                    if (tabName === 'Slice') {
                        initializeWaveform();
                    }
                });
            }

            async function fetchContent(tabName) {
                try {
                    const response = await fetch(`/${tabName.toLowerCase()}`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.text();
                    document.getElementById(tabName).innerHTML = data;
                } catch (error) {
                    document.getElementById(tabName).innerHTML = `<p style="color: red;">Error loading content: ${error}</p>`;
                }
            }

            function attachFormHandler(tabName) {
                const form = document.querySelector(`#${tabName} form`);
                if (form) {
                    form.addEventListener('submit', async function(event) {
                        event.preventDefault(); // Prevent the default form submission

                        const formData = new FormData(form);
                        const url = `/${tabName.toLowerCase()}`;
                        const method = form.method.toUpperCase();

                        try {
                            const response = await fetch(url, {
                                method: method,
                                body: formData
                            });

                            // Check if the response is an attachment
                            const contentDisposition = response.headers.get('Content-Disposition');
                            if (contentDisposition && contentDisposition.includes('attachment')) {
                                const blob = await response.blob();
                                const urlBlob = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = urlBlob;
                                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                                const filename = filenameMatch ? filenameMatch[1] : 'download.zip';
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                window.URL.revokeObjectURL(urlBlob);
                            } else {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                const result = await response.text();
                                document.getElementById(tabName).innerHTML = result;

                                // Re-attach the form handler in case of multiple submissions
                                attachFormHandler(tabName);
                                if (tabName === 'Slice') {
                                    initializeWaveform();
                                }
                            }
                        } catch (error) {
                            document.getElementById(tabName).innerHTML = `<p style="color: red;">Error submitting form: ${error}</p>`;
                        }
                    });
                }
            }

            // Create or retrieve the WaveSurfer instance
            function initializeWaveform() {
                const waveform = document.getElementById('waveform');
                
                // If there's a placeholder for waveform and no existing wavesurfer, create it
                if (waveform && !waveform.waveSurferInstance) {
                    wavesurfer = WaveSurfer.create({
                        container: '#waveform',
                        waveColor: 'violet',
                        progressColor: 'purple',
                        height: 128,
                        responsive: true,
                        plugins: [WaveSurfer.regions.create({})]
                    });

                    // When audio is first loaded, set flag and create initial slices
                    wavesurfer.on('ready', () => {
                        audioReady = true;
                        recalcSlices();
                    });

                    // Listen for region clicks to play that slice
                    wavesurfer.on('region-click', (region, e) => {
                        e.stopPropagation(); 
                        region.play();
                    });

                    // Store this instance to avoid re-initializing
                    waveform.waveSurferInstance = wavesurfer;
                }

                // Listen for changes in num_slices input to recalc slices
                const numSlicesInput = document.getElementById('num_slices');
                if (numSlicesInput) {
                    // Change event fires when user leaves the field or presses Enter
                    // If you want "live" updates while typing, use "input" instead
                    numSlicesInput.addEventListener('change', function() {
                        if (audioReady) {
                            recalcSlices();
                        }
                    });
                }

                // Listen for a new file selection
                const fileInput = document.getElementById('file');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            // Clear old regions and load new file
                            wavesurfer.clearRegions();
                            audioReady = false;
                            wavesurfer.loadBlob(file);
                        }
                    });
                }
            }

            // Recalculate slices based on the current value in num_slices
            function recalcSlices() {
                if (!audioReady || !wavesurfer) return;

                const numSlicesInput = document.getElementById('num_slices');
                if (!numSlicesInput) return;

                const numSlices = parseInt(numSlicesInput.value, 10) || 0;

                // Clear existing slices
                wavesurfer.clearRegions();

                if (numSlices > 0) {
                    const duration = wavesurfer.getDuration();
                    const sliceDuration = duration / numSlices;
                    for (let i = 0; i < numSlices; i++) {
                        wavesurfer.addRegion({
                            start: i * sliceDuration,
                            end: (i + 1) * sliceDuration,
                            color: 'rgba(0, 255, 0, 0.2)',
                            drag: false,
                            //resize: false
                        });
                    }
                }
            }

            // Open the default tab when the page loads
            window.onload = function() {
                document.getElementById("defaultOpen").click();
            }
        </script>
    </head>
    <body>
        <h1>Move - Extended</h1>
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Slice')" id="defaultOpen">Slice Kit</button>
            <button class="tablinks" onclick="openTab(event, 'Refresh')">Refresh Library</button>
        </div>

        <div id="Slice" class="tabcontent">
            <!-- The Slice Kit form content will be loaded here dynamically -->
        </div>

        <div id="Refresh" class="tabcontent">
            <!-- The Refresh Library form content will be loaded here dynamically -->
        </div>
    </body>
</html>