{% extends "base.html" %}
{% block content %}
<h2>Synth Parameter Editor (Drift)</h2>
<p><em>Edit parameter values and save as a new preset.</em></p>
{% if message %}
  <p class="{{ message_type if message_type else ('success' if success else 'error') }}">{{ message }}</p>
{% endif %}
{% if not preset_selected %}
<form method="post" action="{{ host_prefix }}/synth-params" style="margin-bottom:1em;">
    <input type="hidden" name="action" value="new_preset">
    <input type="hidden" name="preset_select" value="{{ default_preset_path }}">
    <button type="submit">Create New Drift Preset</button>
</form>
<div class="file-browser" data-root="{{ browser_root }}" data-action="{{ host_prefix }}/synth-params" data-field="preset_select" data-value="select_preset" data-filter="drift">
    {{ file_browser_html | safe }}
</div>
{% else %}
<form method="post" action="{{ host_prefix }}/synth-params" id="param-form">
    <input type="hidden" name="action" id="action-input" value="save_params">
    <input type="hidden" name="preset_select" value="{{ selected_preset }}">
    <input type="hidden" name="param_count" value="{{ param_count }}">
    <p class="current-preset">Editing: {{ selected_preset.split('/')[-1] }}</p>
    {% set _basename = selected_preset.split('/')[-1] %}
    {% if _basename.endswith('.json') or _basename.endswith('.ablpreset') %}
        {% set _prefill = _basename.rsplit('.', 1)[0] %}
    {% else %}
        {% set _prefill = _basename %}
    {% endif %}
    <div class="preset-controls">
        <label>Preset Name:
            <input type="text" name="new_preset_name" id="new-preset-name" data-original-name="{{ _basename }}" value="{{ _prefill }}" {% if not rename_checked %}disabled{% endif %}>
        </label>
        <label><input type="checkbox" name="rename" id="rename-checkbox" {% if rename_checked %}checked{% endif %}> Save as new</label>
    </div>
    <div class="preset-actions">
        <button type="submit">Save Parameters</button>
        <button type="submit" onclick="document.getElementById('action-input').value='reset_preset';">Choose Another Preset</button>
    </div>
    {{ macro_knobs_html | safe }}
    <div class="edit-macros-link">
        <a href="{{ host_prefix }}/synth-macros?preset={{ selected_preset | urlencode }}">Edit Macros</a>
    </div>
    <div class="param-list">
        {{ params_html | safe }}
    </div>
</form>

{% endif %}
{% endblock %}
{% block scripts %}
<script type="module" src="{{ host_prefix }}/static/file_browser.js"></script>
<script src="{{ host_prefix }}/static/shared.js"></script>
<script>
  window.inputKnobsOptions = { knobDiameter: 32 };
</script>
<script src="{{ host_prefix }}/static/input-knobs.js"></script>
<script src="{{ host_prefix }}/static/params_knobs.js"></script>
<script src="{{ host_prefix }}/static/rect-slider.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const cb = document.getElementById('rename-checkbox');
  const nameInput = document.getElementById('new-preset-name');
  if (cb && nameInput) {
    cb.addEventListener('change', () => {
      nameInput.disabled = !cb.checked;
    });
    const form = document.getElementById('param-form');
    const orig = nameInput.dataset.originalName;
    if (form && orig) {
      form.addEventListener('submit', (e) => {
        if (!cb.checked) return;
        let newName = nameInput.value.trim();
        if (!newName.endsWith('.ablpreset') && !newName.endsWith('.json')) {
          newName += '.ablpreset';
        }
        if (newName === orig) {
          if (!confirm('This will overwrite the existing preset. Continue?')) {
            e.preventDefault();
          }
        }
      });
    }
  }

});
</script>
{% endblock %}

