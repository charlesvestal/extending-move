<h2>Drum Rack Inspector</h2>
<p><em>Note: this inspects the samples from a drum rack, but does not take into account any start / hold / length times, including slice information. Reversing a sample will create a new copy of the raw sound file itself!</em></p>
{message_html}

<form method="POST" action="/drum-rack-inspector">
    <input type="hidden" name="action" value="select_preset">
    <label for="preset_select">Select a Drum Rack:</label>
    <select name="preset_select" id="preset_select">
        {{ options }}
    </select>
</form>

<div class="samples-container">
    {{ samples_html }}
</div>

  <!-- Time Stretch Modal -->
  <style>
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
             background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
    .modal.hidden { display: none; }
    .modal-content { background: #fff; padding: 20px; border-radius: 4px; position: relative; }
    .modal-close { position: absolute; top: 10px; right: 10px; cursor: pointer; }
  </style>
  <div id="timeStretchModal" class="modal hidden">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <form method="POST" action="/drum-rack-inspector" id="timeStretchForm" onsubmit="event.preventDefault(); submitTimeStretchForm();">
        <input type="hidden" name="action" value="time_stretch_sample">
        <input type="hidden" name="sample_path" id="ts_sample_path">
        <input type="hidden" name="preset_path" id="ts_preset_path">
        <input type="hidden" name="pad_number" id="ts_pad_number">
        <label for="ts_bpm">BPM:</label>
        <input type="number" name="bpm" id="ts_bpm" step="0.1" required>
        <label for="ts_measures">Measures:</label>
        <input type="number" name="measures" id="ts_measures" step="0.1" required>
        <button type="submit" class="apply-time-stretch-button">Apply</button>
      </form>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('timeStretchModal');
      const closeBtn = modal.querySelector('.modal-close');
      const form = document.getElementById('timeStretchForm');
      document.querySelectorAll('.time-stretch-button').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('ts_sample_path').value = btn.getAttribute('data-sample-path');
          document.getElementById('ts_preset_path').value = btn.getAttribute('data-preset-path');
          document.getElementById('ts_pad_number').value = btn.getAttribute('data-pad-number');
          modal.classList.remove('hidden');
        });
      });
      closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
      window.addEventListener('click', e => { if (e.target === modal) modal.classList.add('hidden'); });
    });
  </script>

  <script>
    function submitTimeStretchForm() {
      const form = document.getElementById('timeStretchForm');
      const url = form.getAttribute('action');
      const formData = new FormData(form);
      fetch(url, {
        method: form.method,
        body: formData
      })
      .then(response => response.text())
      .then(html => {
        // Replace tab content (including modal) with new HTML
        const container = form.closest('.tabcontent');
        container.innerHTML = html;
      })
      .catch(err => console.error(err));
    }
  </script>
