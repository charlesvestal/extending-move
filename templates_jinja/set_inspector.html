{% extends "base.html" %}
{% block content %}
<h2>Set Inspector</h2>
<p><em>Note: This will edit your sets, and a broken set can't be loaded. Back up your sets before making modifications!</em></p>
{% if message %}
  <p class="{{ message_type if message_type else ('success' if success else 'error') }}">{{ message }}</p>
{% endif %}
{% if not selected_set %}
  <form id="setSelectForm" method="post" action="{{ host_prefix }}/set-inspector" style="margin-bottom:1rem;">
    <input type="hidden" name="action" value="select_set">
    {{ pad_grid | safe }}
    <button type="submit">Load Set</button>
    <span id="selected-set-name" style="margin-left:1rem;"></span>
  </form>
{% elif not selected_clip %}
  <nav class="breadcrumbs" style="margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;">
    <form method="get" action="{{ host_prefix }}/set-inspector" style="display:inline;">
      <button type="submit" class="link-button">{{ set_name }}</button>
    </form>
    <a href="{{ host_prefix }}/set-inspector" class="mini-grid">{{ pad_grid | safe }}</a>
  </nav>
  <form id="clipSelectForm" method="post" action="{{ host_prefix }}/set-inspector" style="margin-bottom:1rem;">
    <input type="hidden" name="action" value="show_clip">
    <input type="hidden" name="set_path" value="{{ selected_set }}">
    {{ clip_grid | safe }}
    <span id="selected-clip-name" style="margin-left:1rem;"></span>
  </form>
  <!-- <form method="get" action="{{ host_prefix }}/set-inspector" style="margin-bottom:1rem;">
    <button type="submit">Choose Another Set</button>
  </form> -->
{% else %}
  <nav class="breadcrumbs" style="margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;">
    <form method="get" action="{{ host_prefix }}/set-inspector" style="display:inline;">
      <button type="submit" class="link-button">{{ set_name }}</button>
    </form>
    <a href="{{ host_prefix }}/set-inspector" class="mini-grid">{{ pad_grid | safe }}</a>
    -
    <form method="post" action="{{ host_prefix }}/set-inspector" style="display:inline;">
      <input type="hidden" name="action" value="select_set">
      <input type="hidden" name="set_path" value="{{ selected_set }}">
      <button type="submit" class="link-button">Track {{ (track_index + 1) if track_index is not none else '?' }}: {{ track_name }}</button>
    </form>
    <form id="miniClipForm" method="post" action="{{ host_prefix }}/set-inspector" style="display:inline; margin:0;">
      <input type="hidden" name="action" value="select_set">
      <input type="hidden" name="set_path" value="{{ selected_set }}">
      <button type="submit" class="mini-grid" style="border:none; background:none; padding:0;">{{ clip_grid | safe }}</button>
    </form>
    - Clip {{ (clip_index + 1) if clip_index is not none else '?' }}
  </nav>
  <!-- <form method="post" action="{{ host_prefix }}/set-inspector" style="display:inline;">
    <input type="hidden" name="action" value="select_set">
    <input type="hidden" name="set_path" value="{{ selected_set }}">
    <button type="submit">Back to Clips</button>
  </form>
  <form method="get" action="{{ host_prefix }}/set-inspector" style="margin-left:1rem; display:inline;">
    <button type="submit">Choose Another Set</button>
  </form> -->
  <div style="margin-top:1rem; display:flex; align-items:center;">
    <label for="envelope_select">Envelope:</label>
    <select id="envelope_select">{{ clip_options | safe }}</select>
    <button id="editEnvBtn" type="button" style="margin-left:0.5rem; display:none;">Edit Envelope</button>
    <form id="saveEnvForm" method="post" action="{{ host_prefix }}/set-inspector" style="margin-left:0.5rem; display:none;">
      <input type="hidden" name="action" value="save_envelope">
      <input type="hidden" name="set_path" value="{{ selected_set }}">
      <input type="hidden" name="clip_select" value="{{ selected_clip }}">
      <input type="hidden" name="parameter_id" id="parameter_id_input">
      <input type="hidden" name="envelope_data" id="envelope_data_input">
      <button id="saveEnvBtn" type="submit" disabled>Save Envelope</button>
    </form>
    <span id="envValue" style="margin-left:0.5rem; font-size:0.8em;"></span>
  </div>
  <div style="margin-top:1rem; display:flex; align-items:flex-start;">
    <div style="position:relative; width:400px; height:200px; border:1px solid #ccc;">
      <webaudio-pianoroll id="clipEditor" width="400" height="200" editmode="dragpoly"></webaudio-pianoroll>
      <canvas id="clipCanvas" width="400" height="200" style="position:absolute; left:0; top:0; pointer-events:none;"></canvas>
    </div>
    <div id="paramLegend" style="margin-left:0.5rem; font-size:10px; line-height:1.2; display:flex; flex-direction:column; justify-content:space-between; align-items:flex-end; height:200px;"></div>
  </div>
  <div id="clipData" data-notes='{{ notes | tojson }}' data-envelopes='{{ envelopes | tojson }}' data-region='{{ region }}' data-param-ranges='{{ param_ranges_json | safe }}'></div>
  {% endif %}
{% endblock %}
{% block scripts %}
<script src="{{ host_prefix }}/static/webaudio-pianoroll.js"></script>
<script type="module" src="{{ host_prefix }}/static/set_inspector.js"></script>
{% endblock %}
